<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Ice Cream Co. — Checkout</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>
  <body class="min-h-screen bg-neutral-50 text-neutral-900 antialiased selection:bg-indigo-200/50 selection:text-indigo-900" style="font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;">
    <!-- Top bar -->
    <div class="w-full border-b border-neutral-200 bg-white/70 backdrop-blur">
      <div class="mx-auto max-w-7xl px-4 sm:px-6">
        <div class="flex h-14 items-center justify-between">
          <!-- Logo -->
          <a th:href="@{/catalog/list}" class="flex items-center gap-2 group">
            <div class="flex h-8 w-8 items-center justify-center rounded-md bg-neutral-900 text-white ring-1 ring-neutral-900/10 shadow-sm">
              <span class="text-sm font-semibold tracking-tight">IC</span>
            </div>
            <div class="hidden sm:block">
              <span class="text-base font-semibold tracking-tight">Ice Cream Co.</span>
            </div>
          </a>
          <!-- Spacer -->
          <div class="flex-1 px-4"></div>
          <!-- Actions -->
          <div class="flex items-center gap-2">
            <a id="openCartBtn" href="#orderSummary" class="relative inline-flex items-center gap-2 rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm font-medium text-neutral-700 shadow-sm hover:bg-neutral-50 hover:border-neutral-300 focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
              <i data-lucide="shopping-cart"></i>
              <span class="hidden sm:inline">Cart</span>
              <span id="cartCountBadge" class="absolute -right-2 -top-2 inline-flex h-5 min-w-[20px] items-center justify-center rounded-full bg-neutral-900 px-1.5 text-[11px] font-semibold leading-none text-white ring-2 ring-white">0</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Page header -->
    <header class="mx-auto max-w-7xl px-4 sm:px-6 pt-8 sm:pt-10">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h1 class="text-3xl sm:text-4xl font-semibold tracking-tight">Checkout</h1>
          <p class="mt-2 text-sm sm:text-base text-neutral-600">Secure checkout. We’ll never store your raw card data on our servers.</p>
        </div>
        <div class="flex items-center gap-3">
          <a th:href="@{/catalog/list}" class="inline-flex items-center gap-2 rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm font-medium text-neutral-700 shadow-sm hover:bg-neutral-50 hover:border-neutral-300 focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
            <i data-lucide="arrow-left"></i>
            Continue shopping
          </a>
        </div>
      </div>
      <div class="mt-6 border-t border-neutral-200"></div>
    </header>

    <!-- Error/Success Messages -->
    <div th:if="${error}" class="mx-auto max-w-7xl px-4 sm:px-6 mb-4">
      <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3">
        <div class="flex">
          <div class="flex-shrink-0">
            <i data-lucide="alert-circle" class="h-5 w-5 text-red-400"></i>
          </div>
          <div class="ml-3">
            <p class="text-sm text-red-800" th:text="${error}"></p>
          </div>
        </div>
      </div>
    </div>

    <div th:if="${success}" class="mx-auto max-w-7xl px-4 sm:px-6 mb-4">
      <div class="rounded-lg border border-green-200 bg-green-50 px-4 py-3">
        <div class="flex">
          <div class="flex-shrink-0">
            <i data-lucide="check-circle" class="h-5 w-5 text-green-400"></i>
          </div>
          <div class="ml-3">
            <p class="text-sm text-green-800" th:text="${success}"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main -->
    <main class="mx-auto max-w-7xl px-4 sm:px-6 py-8">
      <!-- Left: Form -->
        <div class="lg:col-span-3">
          <div class="rounded-2xl bg-white border border-neutral-200 shadow-sm p-5 sm:p-6">
            <!-- NOTE: action updated to match controller endpoint /cart-save and model is 'product' (CheckoutForm DTO) -->
            <form th:action="@{/catalog/cart-save}" th:object="${product}" method="post" id="checkoutForm">
              <input type="hidden" name="cartPayload" id="cartPayload" />
              <div class="space-y-6">
                <!-- Contact Section -->
                <section>
                  <div class="border-b border-neutral-200 pb-4 mb-4">
                    <div class="flex items-center gap-2">
                      <i data-lucide="user" class="text-neutral-700"></i>
                      <h2 class="text-lg font-semibold tracking-tight">Contact</h2>
                    </div>
                  </div>
                  <div class="space-y-4">
                    <div class="grid grid-cols-1 gap-4">
                      <label class="block">
                        <span class="mb-1 block text-sm text-neutral-700">Email address</span>
                        <div class="relative">
                          <i data-lucide="mail" class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"></i>
                          <input id="email" type="email" th:field="*{email}" placeholder="you@example.com" class="w-full rounded-lg border border-neutral-200 bg-white pl-10 pr-3 py-2.5 text-sm text-neutral-900 placeholder:text-neutral-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500" />
                          <div th:if="${#fields.hasErrors('email')}" class="mt-1 text-sm text-red-600" th:errors="*{email}"></div>
                        </div>
                      </label>
                      <label class="inline-flex items-center gap-3 select-none cursor-pointer">
                        <span class="relative">
                          <input id="saveInfo" type="checkbox" class="peer sr-only" />
                          <span class="h-4 w-4 rounded border border-neutral-300 bg-white ring-1 ring-neutral-200 peer-checked:bg-neutral-900 peer-checked:border-neutral-900 block transition-colors"></span>
                          <i data-lucide="check" class="pointer-events-none absolute -left-[1px] -top-[1px] h-4 w-4 text-white opacity-0 peer-checked:opacity-100"></i>
                        </span>
                        <span class="text-sm text-neutral-700">Save my info for next time</span>
                      </label>
                    </div>
                  </div>
                </section>

                <!-- Shipping address Section -->
                <section>
                  <div class="border-b border-neutral-200 pb-4 mb-4">
                    <div class="flex items-center gap-2">
                      <i data-lucide="map-pin" class="text-neutral-700"></i>
                      <h2 class="text-lg font-semibold tracking-tight">Shipping address</h2>
                    </div>
                  </div>
                  <div class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <label class="block">
                        <span class="mb-1 block text-sm text-neutral-700">First name</span>
                        <input id="firstName" type="text" th:field="*{firstName}" class="w-full rounded-lg border border-neutral-200 bg-white px-3 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500" />
                        <div th:if="${#fields.hasErrors('firstName')}" class="mt-1 text-sm text-red-600" th:errors="*{firstName}"></div>
                      </label>
                      <label class="block">
                        <span class="mb-1 block text-sm text-neutral-700">Last name</span>
                        <input id="lastName" type="text" th:field="*{lastName}" class="w-full rounded-lg border border-neutral-200 bg-white px-3 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500" />
                        <div th:if="${#fields.hasErrors('lastName')}" class="mt-1 text-sm text-red-600" th:errors="*{lastName}"></div>
                      </label>
                    </div>
                    <label class="block">
                      <span class="mb-1 block text-sm text-neutral-700">Address</span>
                      <input id="address1" type="text" th:field="*{address}" placeholder="Street address" class="w-full rounded-lg border border-neutral-200 bg-white px-3 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500" />
                      <div th:if="${#fields.hasErrors('address')}" class="mt-1 text-sm text-red-600" th:errors="*{address}"></div>
                    </label>
                    <label class="block">
                      <span class="mb-1 block text-sm text-neutral-700">Apartment, suite, etc. (optional)</span>
                      <input id="address2" type="text" th:field="*{apartment}" class="w-full rounded-lg border border-neutral-200 bg-white px-3 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500" />
                    </label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                      <label class="block sm:col-span-2">
                        <span class="mb-1 block text-sm text-neutral-700">City</span>
                        <input id="city" type="text" th:field="*{city}" class="w-full rounded-lg border border-neutral-200 bg-white px-3 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500" />
                        <div th:if="${#fields.hasErrors('city')}" class="mt-1 text-sm text-red-600" th:errors="*{city}"></div>
                      </label>
                      <label class="block">
                        <span class="mb-1 block text-sm text-neutral-700">Postal code</span>
                        <input id="postal" type="text" th:field="*{pincode}" class="w-full rounded-lg border border-neutral-200 bg-white px-3 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500" />
                        <div th:if="${#fields.hasErrors('pincode')}" class="mt-1 text-sm text-red-600" th:errors="*{pincode}"></div>
                      </label>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <label class="block">
                        <span class="mb-1 block text-sm text-neutral-700">State / Province</span>
                        <input id="region" type="text" th:field="*{state}" class="w-full rounded-lg border border-neutral-200 bg-white px-3 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500" />
                        <div th:if="${#fields.hasErrors('state')}" class="mt-1 text-sm text-red-600" th:errors="*{state}"></div>
                      </label>
                      <label class="block">
                        <span class="mb-1 block text-sm text-neutral-700">Country</span>
                        <input id="country" type="text" value="India" th:field="*{country}" class="w-full rounded-lg border border-neutral-200 bg-white px-3 py-2.5 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500" />
                        <div th:if="${#fields.hasErrors('country')}" class="mt-1 text-sm text-red-600" th:errors="*{country}"></div>
                      </label>
                    </div>
                  </div>
                </section>

                <!-- Shipping method Section -->
                <section>
                  <div class="border-b border-neutral-200 pb-4 mb-4">
                    <div class="flex items-center gap-2">
                      <i data-lucide="truck" class="text-neutral-700"></i>
                      <h2 class="text-lg font-semibold tracking-tight">Shipping method</h2>
                    </div>
                  </div>
                  <div class="space-y-3">
                    <button data-ship="standard" type="button" class="w-full flex items-center justify-between gap-3 rounded-xl border border-neutral-200 bg-white px-4 py-3 text-left hover:border-neutral-300 focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
                      <div class="flex items-center gap-3">
                        <span class="relative">
                          <span class="h-4 w-4 rounded-full border border-neutral-300 ring-1 ring-neutral-200 block"></span>
                          <span class="absolute inset-[3px] rounded-full bg-neutral-900 opacity-0" data-radio-dot></span>
                        </span>
                        <div>
                          <div class="text-sm font-medium text-neutral-900">Standard</div>
                          <div class="text-xs text-neutral-600">5-6 working hours</div>
                        </div>
                      </div>
                      <div class="text-sm font-semibold" data-ship-price>₹4.99</div>
                    </button>
                    <button data-ship="express" type="button" class="w-full flex items-center justify-between gap-3 rounded-xl border border-neutral-200 bg-white px-4 py-3 text-left hover:border-neutral-300 focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
                      <div class="flex items-center gap-3">
                        <span class="relative">
                          <span class="h-4 w-4 rounded-full border border-neutral-300 ring-1 ring-neutral-200 block"></span>
                          <span class="absolute inset-[3px] rounded-full bg-neutral-900 opacity-0" data-radio-dot></span>
                        </span>
                        <div>
                          <div class="text-sm font-medium text-neutral-900">Express</div>
                          <div class="text-xs text-neutral-600">1–2 working hours</div>
                        </div>
                      </div>
                      <div class="text-sm font-semibold" data-ship-price>₹12.00</div>
                    </button>
                  </div>
                </section>

                <!-- Payment Section (use Razorpay Checkout popup) -->
                <section>
                  <div class="border-b border-neutral-200 pb-4 mb-4">
                    <div class="flex items-center gap-2">
                      <i data-lucide="credit-card" class="text-neutral-700"></i>
                      <h2 class="text-lg font-semibold tracking-tight">Payment</h2>
                    </div>
                  </div>
                  <div class="space-y-4">
                    <p class="text-sm text-neutral-600">You will be redirected to Razorpay's secure checkout to complete payment. We do not collect or store raw card numbers on this site.</p>

                    <button type="submit" id="placeOrderBtn" class="mt-2 inline-flex w-full items-center justify-center gap-2 rounded-lg bg-neutral-900 text-white px-4 py-2.5 text-sm font-medium shadow-sm hover:bg-neutral-800 focus:outline-none focus:ring-2 focus:ring-neutral-900/30">
                      <i data-lucide="lock"></i>
                      Pay securely
                    </button>
                    <p class="text-xs text-neutral-500 text-center">By placing your order, you agree to our Terms and Privacy Policy.</p>
                  </div>
                </section>
              </div>
            </form>
          </div>
        </div>    
        <!-- Right: Summary -->
        <div class="pt-5">
            <aside id="orderSummary" class="lg:col-span-2 space-y-6">
          <section class="rounded-2xl bg-white border border-neutral-200 shadow-sm">
            <div class="p-5 sm:p-6 border-b border-neutral-200">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <i data-lucide="receipt" class="text-neutral-700"></i>
                  <h2 class="text-lg font-semibold tracking-tight">Order summary</h2>
                </div>
                <span id="summaryCount" class="text-sm text-neutral-600"></span>
              </div>
            </div>
            <div id="summaryItems" class="p-5 sm:p-6 space-y-3 max-h-[360px] overflow-auto">
              <!-- Items render here -->
            </div>
            <div class="px-5 sm:px-6">
              <div class="border-t border-neutral-200"></div>
            </div>
            <div class="p-5 sm:p-6 space-y-3">
              <div class="flex items-center gap-2">
                <div class="relative flex-1">
                  <i data-lucide="ticket" class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400"></i>
                  <input id="promoInput" type="text" placeholder="Promo code" class="w-full rounded-lg border border-neutral-200 bg-white pl-10 pr-3 py-2.5 text-sm text-neutral-900 placeholder:text-neutral-400 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/40 focus:border-indigo-500" />
                </div>
                <button id="applyPromoBtn" class="inline-flex items-center justify-center gap-2 rounded-lg border border-neutral-200 bg-white px-3 py-2 text-sm font-medium text-neutral-700 shadow-sm hover:bg-neutral-50 hover:border-neutral-300 focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
                  Apply
                </button>
              </div>
              <div id="promoNote" class="hidden text-xs text-emerald-600">Promo applied.</div>
              <div class="space-y-2 pt-2">
                <div class="flex items-center justify-between text-sm">
                  <span class="text-neutral-600">Subtotal</span>
                  <span id="subtotal" class="text-neutral-900 font-medium">₹0.00</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                  <span class="text-neutral-600">Discount</span>
                  <span id="discount" class="text-neutral-900 font-medium">-₹0.00</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                  <span class="text-neutral-600">Shipping</span>
                  <span id="shipping" class="text-neutral-900 font-medium">₹0.00</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                  <span class="text-neutral-600">Tax</span>
                  <span id="tax" class="text-neutral-900 font-medium">₹0.00</span>
                </div>
                <div class="border-t border-neutral-200 my-2"></div>
                <div class="flex items-center justify-between">
                  <span class="text-base font-medium">Total</span>
                  <span id="total" class="text-base font-semibold">₹0.00</span>
                </div>
              </div>
            </div>
          </section>

          <section class="rounded-2xl bg-white border border-neutral-200 shadow-sm">
            <div class="p-5 sm:p-6">
              <div class="flex items-center gap-2 text-sm text-neutral-600">
                <i data-lucide="shield-check"></i>
                <span>30-day happiness guarantee.</span>
              </div>
            </div>
          </section>
        </aside>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mx-auto max-w-7xl px-4 sm:px-6 pb-10">
      <div class="mt-6 border-t border-neutral-200"></div>
      <div class="pt-6 flex flex-col sm:flex-row items-center justify-between gap-3 text-sm text-neutral-600">
        <p>© <span id="year"></span> Ice Cream Co. All rights reserved.</p>
        <div class="flex items-center gap-4">
          <a href="#" class="hover:text-neutral-900 hover:underline underline-offset-4">Shipping</a>
          <a href="#" class="hover:text-neutral-900 hover:underline underline-offset-4">Returns</a>
          <a href="#" class="hover:text-neutral-900 hover:underline underline-offset-4">Contact</a>
        </div>
      </div>
    </footer>

    <!-- Success toast -->
    <div id="orderSuccess" class="hidden fixed top-4 left-1/2 -translate-x-1/2 z-50">
      <div class="inline-flex items-center gap-3 rounded-xl border border-emerald-200 bg-white px-4 py-3 shadow-lg ring-1 ring-emerald-200/40">
        <i data-lucide="badge-check" class="text-emerald-600"></i>
        <div>
          <div class="text-sm font-semibold text-neutral-900">Order placed</div>
          <div class="text-xs text-neutral-600">Thanks! Your order <span id="orderId"></span> is confirmed.</div>
        </div>
      </div>
    </div>

    <script>
      // Icon render with 1.5 stroke width
      document.addEventListener('DOMContentLoaded', () => {
        if (window.lucide) {
          lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });
        }
      });

      // Simple cross-page cart persistence key
      const CART_KEY = 'icc_cart';
      const currency = new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' });

      const yearEl = document.getElementById('year');
      yearEl.textContent = new Date().getFullYear();

      const cartCountBadge = document.getElementById('cartCountBadge');
      const summaryItemsEl = document.getElementById('summaryItems');
      const summaryCountEl = document.getElementById('summaryCount');

      const subtotalEl = document.getElementById('subtotal');
      const discountEl = document.getElementById('discount');
      const shippingEl = document.getElementById('shipping');
      const taxEl = document.getElementById('tax');
      const totalEl = document.getElementById('total');

      const promoInput = document.getElementById('promoInput');
      const promoBtn = document.getElementById('applyPromoBtn');
      const promoNote = document.getElementById('promoNote');

      const placeOrderBtn = document.getElementById('placeOrderBtn');
      const checkoutForm = document.getElementById('checkoutForm');
      const orderSuccess = document.getElementById('orderSuccess');
      const orderIdEl = document.getElementById('orderId');

      const shippingButtons = Array.from(document.querySelectorAll('[data-ship]'));

      let cart = loadCart();
      let promo = null; // { code: string, percent: number }
      let shippingMethod = 'standard';
      const shippingPrices = { standard: 4.99, express: 12.0 };
      const taxRate = 0.085;

      function loadCart() {
        try {
          const raw = localStorage.getItem(CART_KEY);
          if (!raw) return {};
          const parsed = JSON.parse(raw);
          const valid = {};
          Object.values(parsed).forEach((item) => {
            if (item && item.id) {
              valid[item.id] = {
                id: String(item.id),
                name: String(item.name || ''),
                price: Number(item.price || 0),
                qty: Math.max(0, parseInt(item.qty || 0, 10))
              };
            }
          });
          return valid;
        } catch {
          return {};
        }
      }

      function saveCart() {
        localStorage.setItem(CART_KEY, JSON.stringify(cart));
      }

      function updateBadge() {
        const count = Object.values(cart).reduce((s, i) => s + i.qty, 0);
        cartCountBadge.textContent = count;
        cartCountBadge.classList.toggle('hidden', count === 0);
        summaryCountEl.textContent = count > 0 ? `${count} item${count > 1 ? 's' : ''}` : '';
      }

      function renderSummary() {
        summaryItemsEl.innerHTML = '';
        const items = Object.values(cart).filter((i) => i.qty > 0);
        if (items.length === 0) {
          summaryItemsEl.innerHTML = `
            <div class="flex flex-col items-center justify-center text-center rounded-xl border border-dashed border-neutral-200 p-10">
              <i data-lucide="ice-cream" class="mb-2 text-neutral-400"></i>
              <p class="text-sm text-neutral-600">Your cart is empty.</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons({ attrs: { 'stroke-width': 1.5 }});
        } else {
          items.forEach((item) => {
            const row = document.createElement('div');
            row.className = 'flex items-center gap-3 rounded-xl border border-neutral-200 p-3';
            row.innerHTML = `
              <div class="relative h-14 w-14 overflow-hidden rounded-lg ring-1 ring-neutral-200 bg-neutral-100">
                <div class="h-full w-full flex items-center justify-center text-neutral-500 bg-neutral-100">
                  <i data-lucide="ice-cream"></i>
                </div>
                <span class="absolute -right-1 -top-1 inline-flex items-center justify-center h-5 min-w-[20px] rounded-full bg-neutral-900 text-white text-[11px] font-semibold px-1.5 ring-2 ring-white">${item.qty}</span>
              </div>
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-3">
                  <div class="truncate">
                    <div class="text-sm font-semibold truncate">${item.name || 'Item'}</div>
                    <div class="text-xs text-neutral-600">${currency.format(item.price)} · item</div>
                  </div>
                  <div class="text-sm font-semibold whitespace-nowrap">${currency.format(item.price * item.qty)}</div>
                </div>
                <div class="mt-2 flex items-center justify-between">
                  <div class="inline-flex items-center gap-2">
                    <button data-action="decrement" data-id="${item.id}" class="inline-flex items-center justify-center rounded-md border border-neutral-200 bg-white p-1.5 text-neutral-700 hover:bg-neutral-50 hover:border-neutral-300 focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
                      <i data-lucide="minus"></i>
                    </button>
                    <span class="min-w-[2ch] text-sm text-neutral-900 text-center">${item.qty}</span>
                    <button data-action="increment" data-id="${item.id}" class="inline-flex items-center justify-center rounded-md border border-neutral-200 bg-white p-1.5 text-neutral-700 hover:bg-neutral-50 hover:border-neutral-300 focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
                      <i data-lucide="plus"></i>
                    </button>
                  </div>
                  <button data-action="remove" data-id="${item.id}" class="inline-flex items-center justify-center rounded-md border border-neutral-200 bg-white p-1.5 text-neutral-700 hover:bg-neutral-50 hover:border-neutral-300 focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
                    <i data-lucide="trash-2"></i>
                  </button>
                </div>
              </div>
            `;
            summaryItemsEl.appendChild(row);
          });
          if (window.lucide) lucide.createIcons({ attrs: { 'stroke-width': 1.5 }});
        }
        updateBadge();
        recalcTotals();
      }

      function recalcTotals() {
        const items = Object.values(cart).filter((i) => i.qty > 0);
        const subtotal = items.reduce((s, i) => s + Number(i.price || 0) * i.qty, 0);
        const discount = promo ? +(subtotal * (promo.percent / 100)).toFixed(2) : 0;
        const shipping = items.length > 0 ? shippingPrices[shippingMethod] : 0;
        const taxable = Math.max(0, subtotal - discount) + shipping;
        const tax = +(taxable * taxRate).toFixed(2);
        const total = Math.max(0, subtotal - discount) + shipping + tax;

        subtotalEl.textContent = currency.format(subtotal);
        discountEl.textContent = discount > 0 ? `-${currency.format(discount)}` : '-$0.00';
        shippingEl.textContent = currency.format(shipping);
        taxEl.textContent = currency.format(tax);
        totalEl.textContent = currency.format(total);
      }

      summaryItemsEl.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action]');
        if (!btn) return;
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        if (!cart[id]) return;
        if (action === 'remove') {
          delete cart[id];
        } else if (action === 'increment') {
          cart[id].qty += 1;
        } else if (action === 'decrement') {
          cart[id].qty -= 1;
          if (cart[id].qty <= 0) delete cart[id];
        }
        saveCart();
        renderSummary();
      });

      // Promo codes
      promoBtn.addEventListener('click', () => {
        const code = promoInput.value.trim().toUpperCase();
        if (!code) return;
        if (code === 'SWEET10') {
          promo = { code, percent: 10 };
          promoNote.textContent = 'Promo applied: 10% off.';
          promoNote.classList.remove('hidden');
        } else {
          promo = null;
          promoNote.textContent = 'Invalid code.';
          promoNote.classList.remove('hidden');
          promoNote.classList.remove('text-emerald-600');
          promoNote.classList.add('text-red-600');
          setTimeout(() => {
            promoNote.classList.add('hidden');
            promoNote.classList.remove('text-red-600');
            promoNote.classList.add('text-emerald-600');
          }, 2000);
        }
        recalcTotals();
      });

      // Shipping method custom radios
      function setShipping(method) {
        shippingMethod = method;
        shippingButtons.forEach((btn) => {
          const active = btn.dataset.ship === method;
          const dot = btn.querySelector('[data-radio-dot]');
          if (dot) dot.style.opacity = active ? '1' : '0';
          btn.classList.toggle('ring-2', active);
          btn.classList.toggle('ring-indigo-500/40', active);
          btn.classList.toggle('border-neutral-300', active);
        });
        recalcTotals();
      }
      shippingButtons.forEach((btn) => {
        btn.addEventListener('click', () => setShipping(btn.dataset.ship));
      });
      setShipping('standard');

      // Place order - validate on submit and then allow natural submit
      checkoutForm.addEventListener('submit', (e) => {
        // Basic guard: ensure cart has items
        const hasItems = Object.values(cart).some((i) => i.qty > 0);
        if (!hasItems) {
          e.preventDefault();
          alert('Your cart is empty.');
          return;
        }

        // Validate required fields (no card fields — payment will be handled by Razorpay popup)
        const requiredFields = [
          'email', 'firstName', 'lastName', 'address1', 'city', 'postal', 'region', 'country'
        ];
        let isValid = true;

        requiredFields.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field && !field.value.trim()) {
            isValid = false;
            field.classList.add('border-red-500');
          } else if (field) {
            field.classList.remove('border-red-500');
          }
        });

        if (!isValid) {
          e.preventDefault();
          alert('Please fill in all required fields.');
          return;
        }

        // Serialize cart into hidden field
        const items = Object.values(cart).filter((i) => i.qty > 0).map(i => ({ id: i.id, name: i.name, price: i.price, qty: i.qty }));
        const payloadEl = document.getElementById('cartPayload');
        if (payloadEl) {
          payloadEl.value = JSON.stringify(items);
        }

        // Show processing state
        placeOrderBtn.disabled = true;
        placeOrderBtn.classList.add('opacity-70');
        placeOrderBtn.innerHTML = `<i data-lucide="loader-2" class="animate-spin"></i> Processing...`;
        if (window.lucide) lucide.createIcons({ attrs: { 'stroke-width': 1.5 }});
        // Allow the form to submit to /cart-save which will create a Razorpay order and return the checkout page
      });

      // Header Cart button scrolls to summary
      document.getElementById('openCartBtn').addEventListener('click', (e) => {
        setTimeout(() => {
          document.getElementById('orderSummary')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 0);
      });

      // Initial render
      renderSummary();
    </script>
  </body>
</html>